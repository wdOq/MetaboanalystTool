<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>Quick Analyst - Metaboanalyst</title>
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='jquery-3.7.1.min.js') }}"></script>
    <style>
        body {
            background-color: #f5f6fa;
            font-family: "Segoe UI", Arial, sans-serif;
        }
        h1 {
            font-weight: bold;
            color: #2c3e50;
			font-size: 50pt;
        }
        .card {
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .btn-primary {
            background-color: #3498db;
            border: none;
        }
        .btn-primary:hover {
            background-color: #2980b9;
        }
        #analysisResult {
            min-height: 200px;
            background-color: #ffffff;
            border: 1px dashed #ccc;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            white-space: pre-line;
        }
    </style>
</head>
<body>
<div class="container py-4">
    <!-- 標題 -->
    <div class="text-center mb-4">
        <h1>Quick Analyst</h1>
        <p class="text-muted">Metaboanalyst 自動化分析工具</p>
    </div>

    <!-- 上傳區 -->
    <div class="card p-4 mb-4">
        <h5 class="mb-3">上傳資料</h5>
        <div class="input-group">
            <input type="file" id="fileInput" class="form-control">
            <button id="submitBtn" class="btn btn-primary">開始分析</button>
        </div>
        <small class="text-muted">支援 CSV 格式檔案</small>
    </div>

    <!-- 說明區 -->
    <div class="card p-4 mb-4">
        <h5>Fold Change (FC) Analysis</h5>
        <p class="text-muted">The goal of fold change analysis is to compare the absolute values of change between two group means. Since column-wise normalization (i.e. log transformation and various scaling) will significantly change absolute values, FC calculation are using data before the column-wise normalization was applied (i.e. at the original scale). The significant features are those features whose FCs are beyond the given FC threshold (either up or down). For unpaired analysis, FCs are calculated as the ratios between two group means (M1/M2). For paired analysis, FCs are calculated by computing the ratio between paired samples (i.e. one FC per pair), and then compute their means (i.e. pair means).</p>
        <table class="table table-bordered text-center align-middle">
            <thead class="table-light">
                <tr>
                    <th>Sig. threshold</th>
                    <th>Parameter</th>
                    <th>Formula</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>At least 2 fold difference</td>
                    <td>FC = 2 or FC = 0.5</td>
                    <td>M1/M2 &gt; 2 or M1/M2 &lt; 1/2</td>
                </tr>
                <tr>
                    <td>At least 5 fold difference</td>
                    <td>FC = 5 or FC = 0.2</td>
                    <td>M1/M2 &gt; 5 or M1/M2 &lt; 1/5</td>
                </tr>
                <tr>
                    <td>Any difference</td>
                    <td>FC = 1.0</td>
                    <td>M1/M2 &gt; 1 or M1/M2 &lt; 1</td>
                </tr>
            </tbody>
        </table>
    </div>
	<div class="card p-4 mb-4">
		<h5>Two-sample t-tests & Wilcoxon rank-sum tests</h5>
		<p class="text-muted">For large data set (> 1000 variables), both the paired information and the group variance will be ignored, and the default parameters will be used for t-tests to save computational time. If you choose non-parametric tests (Wilcoxon rank-sum test), the group variance will be ignored.</p>
	</div>

    <!-- 分析結果 -->
    <div class="card p-4">
        <h5>分析結果</h5>
        <div id="analysisResult" class="mt-3">尚未開始分析</div>
        <button id="downloadBtn" class="btn btn-success mt-3" style="display:none;">下載檔案</button>
    </div>
</div>

<!-- 錯誤彈出視窗 -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">錯誤訊息</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="關閉"></button>
            </div>
            <div class="modal-body" id="errorMessage"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function(){
    var checkInterval;
    $("#submitBtn").click(function(){
        var file_data = $("#fileInput")[0].files[0];
        if(!file_data){
            showError("請先選擇檔案");
            return;
        }
        var formData = new FormData();
        formData.append("file", file_data);

        $("#analysisResult").html("<div class='text-primary'>正在上傳並分析，請稍候...</div>");
        $("#downloadBtn").hide();

        $.ajax({
            url: "/upload",
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function(response){
                var taskId = response.task_id;
                checkInterval = setInterval(function(){
                    $.ajax({
                        url: "/task_status/" + taskId,
                        type: "GET",
                        success: function(statusResp){
                            if(statusResp.status === "完成"){
                                clearInterval(checkInterval);
                                $("#analysisResult").html(statusResp.result);
                                if(statusResp.file_name){
                                    $("#downloadBtn").show().off("click").on("click", function(){
                                        window.location.href = "/download/" + statusResp.file_name;
                                    });
                                }
                            } else if(statusResp.status === "失敗" || statusResp.status === "LLM檢測資料錯誤"){
                                clearInterval(checkInterval);
                                showError("分析失敗：" + statusResp.result);
                            } else {
                                $("#analysisResult").html("<div class='text-warning'>分析進行中，請稍候...</div>");
                            }
                        },
                        error: function(){
                            clearInterval(checkInterval);
                            showError("查詢分析狀態時發生錯誤");
                        }
                    });
                }, 1000);
            },
            error: function(){
                showError("上傳失敗，請重試");
            }
        });
    });
});

function showError(msg) {
    $("#errorMessage").text(msg);
    var errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
    errorModal.show();
}
</script>
</body>
</html>
